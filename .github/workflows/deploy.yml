name: Build and Deploy to Compute Engine

on:
  push:
    branches:
      - master

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCE_INSTANCE: tron-bot
  GCE_ZONE: us-central1-a
  IMAGE : discord-bot

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # Setup gcloud CLI
      - uses: google-github-actions/setup-gcloud@v0.2.1
        with:
          service_account_key: ${{ secrets.GCE_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Configure Docker to use the gcloud command-line tool as a credential
      # helper for authentication
      - run: |-
          gcloud --quiet auth configure-docker

      # Build the Docker image
      - name: Build
        run: |-
          docker build \
            --tag "gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA" \
            --build-arg GITHUB_SHA="$GITHUB_SHA" \
            --build-arg GITHUB_REF="$GITHUB_REF" \
            .
      # Push the Docker image to Google Container Registry
      - name: Publish
        run: |-
          docker push "gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA"

      # Send docker-compose file and .bashrc with environment variables
      - name: Transfer Files
        run: |-
          echo """
          export ENV=prod
          export PROJECT_ID=$PROJECT_ID
          export IMAGE=$IMAGE
          export GITHUB_SHA=$GITHUB_SHA
          export DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
          # fixes error with docker-compose in gcloud
          export LD_LIBRARY_PATH=/usr/local/lib
          """ > .bashrc
          gcloud --quiet compute scp .bashrc $GCE_INSTANCE:~ --zone $GCE_ZONE
          gcloud --quiet compute scp docker-compose.prod.yml $GCE_INSTANCE:~ --zone $GCE_ZONE

      # Deploy the Docker image to the GKE cluster
      - name: Deploy
        run: |-
          gcloud compute ssh $GCE_INSTANCE --zone $GCE_ZONE --command \
          '
          gcloud --quiet auth configure-docker "gcr.io" && \
          docker-compose -f "docker-compose.prod.yml" up --remove-orphans --build -d && \
          docker image prune -af \
          '

      - name: Deploy Docs
        run: |-
          docker container run \
          -e GITHUB_ACTOR=$GITHUB_ACTOR \
          -e GITHUB_REPOSITORY=$GITHUB_REPOSITORY \
          -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
          "gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA" \
          /bot/.github/scripts/deploy-docs.sh


      - name: Prune Container Registry
        run: |-
          echo Prune all before $(date +%F)
          ./.github/scripts/gcrgc.sh "gcr.io/$PROJECT_ID/$IMAGE" $(date +%F)
